
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Data wrangling, grouping and aggregation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/landing-page.css?v=ca7933c4" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom-toggle-button.css?v=14db4526" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom-text-formatting.css?v=4ef71e6f" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'part1/chapter-03/md/02-data-analysis';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
    
    <img src="../../../_static/pythongis-logo.png" class="logo__image only-light" alt=" - Home"/>
    <script>document.write(`<img src="../../../_static/pythongis-logo.png" class="logo__image only-dark" alt=" - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Part I - Python essentials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Overview and learning goals</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../chapter-01/index.html">1. Getting started</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-01/nb/0-learning-objectives.html">Learning objectives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-01/nb/00-motivation.html">1.1 Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-01/nb/01-computers-and-programs.html">1.2 Computers and programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-01/nb/02-why-python.html">1.3 Why Python?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-01/nb/03-writing-and-running-python-code.html">1.4 Writing and running Python code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-01/nb/04-using-jupyterlab.html">1.5 Using JupyterLab for writing code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-01/nb/05-quick-start.html">1.6 Quickly getting started (without installing Python)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-01/nb/06-installation.html">1.7 Installing Python and adding libraries</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../chapter-02/index.html">2. Basic programming concepts</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-02/nb/0-learning-objectives.html">Learning objectives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-02/nb/00-python-basics.html">2.1 Getting started with Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-02/nb/01-lists-and-indices.html">2.2 Lists and indices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-02/nb/02-text-and-numbers.html">2.3 Working with text and numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-02/nb/03-for-loops.html">2.4 for loops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-02/nb/04-conditional-statements.html">2.5 Conditional statements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-02/nb/05-functions.html">2.6 Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-02/nb/06-writing-scripts.html">2.7 Writing script files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-02/nb/07-modules.html">2.8 Loading and using modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-02/nb/08-exercises.html">Exercises</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../index.html">3. Introduction to data analysis</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../nb/0-learning-objectives.html">Learning objectives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nb/00-pandas-basics.html">3.1 Getting started with data analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nb/01-data-manipulation.html">3.2 Common tabular operations in pandas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nb/02-data-analysis.html">3.3 Data wrangling, grouping and aggregation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nb/03-temporal-data.html">3.4 Working with temporal data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nb/04-exercises.html">Exercises</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../chapter-04/index.html">4. Introduction to data visualization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-04/nb/0-learning-objectives.html">Learning objectives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-04/nb/00-plotting-in-python.html">4.1 Plotting in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-04/nb/01-basic-plotting.html">4.2 Plotting with pandas and matplotlib</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-04/nb/02-subplots.html">4.3 Creating subplots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-04/nb/03-plot-formatting.html">4.4 Effective plot design: line plots</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../chapter-04/nb/04-exercises.html">Exercises</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part II - Introduction to GIS with Python</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../part2/index.html">Overview and learning goals</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../part2/chapter-05/index.html">5. Getting started</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-05/nb/0-learning-objectives.html">Learning objectives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-05/nb/00-motivation-to-use-python-for-gis.html">5.1 Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-05/nb/01-introduction-to-geographic-data-in-python.html">5.2 Geographic data in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-05/nb/02-introduction-to-coordinate-reference-systems.html">5.3 Coordinate reference systems</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../part2/chapter-06/index.html">6. Vector data processing</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-06/nb/0-learning-objectives.html">Learning objectives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-06/nb/00-introduction-to-geographic-objects.html">6.1 Representing geographic data in vector format</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-06/nb/01-geodataframe.html">6.2 Introduction to geopandas GeoDataFrames</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-06/nb/02-geometric-operations.html">6.3 Common geometric operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-06/nb/03-coordinate-reference-system.html">6.4 Working with map projections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-06/nb/04-geocoding.html">6.5 Geocoding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-06/nb/05-spatial-queries.html">6.6 Selecting data based on spatial relationships</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-06/nb/06-spatial-join.html">6.7 Spatial join</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-06/nb/07-nearest-neighbour.html">6.8 Nearest neighbour analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-06/nb/08-overlay-analysis-with-vector-data.html">6.9 Vector overlay operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-06/nb/09-exercises.html">Exercises</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../part2/chapter-07/index.html">7. Raster data processing</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-07/nb/0-learning-objectives.html">Learning objectives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-07/nb/00-introduction-to-raster-data.html">7.1 Representing geographic data in raster format</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-07/nb/01-data-structures-xarray.html">7.2 Introduction to data structures in xarray</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-07/nb/02-common-raster-operations.html">7.3 Common raster operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-07/nb/03-coordinate-reference-systems-raster.html">7.4 Coordinate reference system management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-07/nb/04-map-algebra.html">7.5 Map algebra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-07/nb/05-data-cubes.html">7.6 Working with data cubes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-07/nb/06-exercises.html">Exercises</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../part2/chapter-08/index.html">8. Geographic data visualization</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-08/nb/0-learning-objectives.html">Learning objectives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-08/nb/00-introduction-to-geographic-visualization.html">8.1 Introduction to geographic visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-08/nb/01-static-vector-maps.html">8.2 Static maps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-08/nb/02-static-raster-maps.html">8.3 Visualizing raster layers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-08/nb/03-interactive-maps.html">8.4 Interactive maps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-08/nb/04-map-design-principles-and-colors.html">8.5 Designing maps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-08/nb/05-exercises.html">Exercises</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../part2/chapter-09/index.html">9. Using online geographic data sources</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-09/nb/0-learning-objectives.html">Learning objectives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-09/nb/00-retrieving-osm-data.html">9.1 Retrieving OpenStreetMap data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-09/nb/01-retrieving-data-from-wfs.html">9.2 Retrieving data from Web Feature Service (WFS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-09/nb/02-retrieving-data-from-wcs.html">9.3 Retrieving data from Web Coverage Service (WCS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-09/nb/03-read-data-from-spatial-databases.html">9.4 Reading data from spatial databases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part2/chapter-09/nb/04-exercises.html">Exercises</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part III - Case studies</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../part3/chapter-10/index.html">10. Spatial interpolation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../part3/chapter-10/nb/00-introduction-to-spatial-interpolation.html">Introduction to spatial interpolation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part3/chapter-10/nb/01-inverse-distance-weighting.html">Inverse Distance Weighting interpolation with Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part3/chapter-10/nb/02-exercises.html">Exercises</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../part3/chapter-11/index.html">11. Spatial network analysis</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../part3/chapter-11/nb/00-introduction-to-spatial-network-analysis.html">Introduction to spatial network analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part3/chapter-11/nb/02-multimodal-spatial-accessibility-modelling.html">Multimodal spatial accessibility analysis with Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../part3/chapter-11/nb/03-exercises.html">Exercises</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../part3/chapter-12/index.html">12. Watershed analysis</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../part3/chapter-12/nb/00-watershed-analysis-with-pysheds.html">Watershed analysis with pysheds</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../../part3/chapter-13/index.html">13. Conclusions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../back-matter/appendix-a.html">A. Working effectively in Python</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../back-matter/nb/appendix-0-python-environments.html">A.1 Tips for maintaining Python environments</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../back-matter/nb/appendix-1-best-practices.html">A.2 Python programming best practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../back-matter/nb/appendix-2-git-github.html">A.3 Version control with using git and GitHub</a></li>










<li class="toctree-l2"><a class="reference internal" href="../../../back-matter/nb/appendix-3-script-files.html">A.4 Using Python script files</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../back-matter/nb/appendix-4-testing-and-debugging.html">A.5 Testing and debugging your code</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../back-matter/appendix-b.html">B. Solutions to questions and exercises</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../back-matter/nb/appendix-5-question-solutions.html">B.1 Question solutions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../back-matter/nb/appendix-6-exercise-solutions.html">B.2 Exercise solutions</a></li>
</ul>
</details></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Back matter</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../back-matter/nb/acknowledgements.html">Acknowledgements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../back-matter/nb/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../back-matter/nb/references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">About the authors</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../data/index.html">Data overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data/noaa-data.html">NOAA Weather data</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/Python-GIS-book/site/edit/main/source/part1/chapter-03/md/02-data-analysis.md" target="_blank"
   class="btn btn-sm btn-source-edit-button"
   title="Suggest edit"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../../_sources/part1/chapter-03/md/02-data-analysis.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Data wrangling, grouping and aggregation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cleaning-data-while-reading">Cleaning data while reading</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#renaming-columns">Renaming columns</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-functions-with-pandas">Using functions with pandas</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-a-function">Defining a function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-a-function-by-iterating-over-rows">Using a function by iterating over rows</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-a-function-with-the-apply-method">Using a function with the apply method</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#string-slicing">String slicing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#question-3-7">Question 3.7</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#grouping-and-aggregating-data">Grouping and aggregating data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-logic-of-grouping-a-dataframe-using-groupby">Basic logic of grouping a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> using <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-data-with-groupby">Aggregating data with <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#case-study-detecting-warm-months">Case study: Detecting warm months</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#automating-the-analysis">Automating the analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#managing-and-listing-filesystem-paths">Managing and listing filesystem paths</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iterate-over-input-files-and-repeat-the-analysis">Iterate over input files and repeat the analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#footnotes">Footnotes</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <!-- #region editable=true slideshow={"slide_type": ""} -->
<section class="tex2jax_ignore mathjax_ignore" id="data-wrangling-grouping-and-aggregation">
<h1>Data wrangling, grouping and aggregation<a class="headerlink" href="#data-wrangling-grouping-and-aggregation" title="Link to this heading">#</a></h1>
<p>Next, we will continue working with weather data but expand our analysis to cover longer periods of data from Finland. In this section, you will learn various useful techniques in <code class="docutils literal notranslate"><span class="pre">pandas</span></code> to manipulate, group, and aggregate the data in different ways that are useful when extracting information from your data. At the end of this section, you will learn how to create an automated data analysis workflow that can be repeated with multiple input files that have a similar structure. As a case study, we will investigate the claim that <a class="reference external" href="https://yle.fi/a/3-12082062">the summer of 2021 was exceptionally warm in Finland</a> <a class="footnote-reference brackets" href="#ylenews" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>.</p>
<!-- #endregion -->
<!-- #region editable=true slideshow={"slide_type": ""} -->
<section id="cleaning-data-while-reading">
<h2>Cleaning data while reading<a class="headerlink" href="#cleaning-data-while-reading" title="Link to this heading">#</a></h2>
<p>In this section we are using weather observation data from Finland that was downloaded from NOAA (check the <a class="reference internal" href="../../../data/index.html"><span class="doc">data overview</span></a> section for more details). The input data are separated by varying number of spaces (i.e., fixed column widths). The first lines of the data look like following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">STATION</span>           <span class="n">ELEVATION</span>  <span class="n">LATITUDE</span>   <span class="n">LONGITUDE</span>  <span class="n">DATE</span>     <span class="n">PRCP</span>     <span class="n">TMAX</span><span class="o">...</span>
<span class="o">-----------------</span> <span class="o">----------</span> <span class="o">----------</span> <span class="o">----------</span> <span class="o">--------</span> <span class="o">--------</span> <span class="o">----...</span>
<span class="n">GHCND</span><span class="p">:</span><span class="n">FIE00142226</span>         <span class="mi">24</span>    <span class="mf">60.2028</span>    <span class="mf">24.9642</span> <span class="mi">20051213</span> <span class="o">-</span><span class="mi">9999</span>    <span class="mi">40</span>  <span class="o">...</span>
<span class="n">GHCND</span><span class="p">:</span><span class="n">FIE00142226</span>         <span class="mi">24</span>    <span class="mf">60.2028</span>    <span class="mf">24.9642</span> <span class="mi">20051214</span> <span class="o">-</span><span class="mi">9999</span>    <span class="mi">35</span>  <span class="o">...</span>
<span class="n">GHCND</span><span class="p">:</span><span class="n">FIE00142226</span>         <span class="mi">24</span>    <span class="mf">60.2028</span>    <span class="mf">24.9642</span> <span class="mi">20051215</span> <span class="o">-</span><span class="mi">9999</span>    <span class="mi">38</span>  <span class="o">...</span>
</pre></div>
</div>
<p>By looking at the file contents above, we can see a few things that we need to consider when reading the data:</p>
<ol class="arabic simple">
<li><p>The delimiter: The columns are separated with a varying amount of spaces which requires using some special tricks when reading the data with the <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">.read_csv()</span></code> function.</p></li>
<li><p>The line of dashes: The second line of the data file contains characters separating the column headings from the data.</p></li>
<li><p>NoData values: <code class="docutils literal notranslate"><span class="pre">NaN</span></code> values in the data file are coded as <code class="docutils literal notranslate"><span class="pre">-9999</span></code> and hence we need to be able to instruct <code class="docutils literal notranslate"><span class="pre">pandas</span></code> to interpret those values as <code class="docutils literal notranslate"><span class="pre">NaN</span></code>.</p></li>
<li><p>Unnecessary columns: The input data contains eight columns, and several of those do not contain data we need. Thus, we should probably ignore the unnecessary columns when reading in the data file.</p></li>
</ol>
<p>Handling and cleaning heterogeneous input data (such as in our example here) can be done after reading in the data. However, in many cases it is preferable to do some cleaning and preprocessing when reading in the data. In fact, it is often much easier to do things this way. Let’s see how we can handle each point above when reading in the data file.</p>
<ol class="arabic simple">
<li><p>For our data file, we can read the data with varying number of spaces between the columns by using the parameter <code class="docutils literal notranslate"><span class="pre">sep=r&quot;\s+&quot;</span></code>. In this case, we use a raw text string with the <code class="docutils literal notranslate"><span class="pre">sep</span></code> parameter, which is indicated by the <code class="docutils literal notranslate"><span class="pre">r</span></code> before the first quotation mark and ensures the escape character <code class="docutils literal notranslate"><span class="pre">\</span></code> is handled properly in the <code class="docutils literal notranslate"><span class="pre">sep</span></code> string.</p></li>
<li><p>The second line of the data file can be skipped using the <code class="docutils literal notranslate"><span class="pre">skiprows</span></code> parameter, as we have seen earlier. However, this time we will give a list of rows to skip (by index value) so that the header line is read, the second line is skipped, and the rest of the file is read. In this case, we can use <code class="docutils literal notranslate"><span class="pre">skiprows=[1]</span></code>.</p></li>
<li><p>For handling the NoData values (point 2 above), we can tell <code class="docutils literal notranslate"><span class="pre">pandas</span></code> to consider <code class="docutils literal notranslate"><span class="pre">-9999</span></code> as <code class="docutils literal notranslate"><span class="pre">NaN</span></code> by using the <code class="docutils literal notranslate"><span class="pre">na_values</span></code> parameter and specifying the character string <code class="docutils literal notranslate"><span class="pre">-9999</span></code> should be converted to <code class="docutils literal notranslate"><span class="pre">NaN</span></code>. For this data file we can specify <code class="docutils literal notranslate"><span class="pre">na_values=[&quot;-9999&quot;]</span></code>, which will then convert the <code class="docutils literal notranslate"><span class="pre">-9999</span></code> values into <code class="docutils literal notranslate"><span class="pre">NaN</span></code> values.</p></li>
<li><p>Finally, we can limit the number of columns that we read (point 3 above) by using the <code class="docutils literal notranslate"><span class="pre">usecols</span></code> parameter, which we have already used previously. In our case, we are interested in columns that might be somehow useful to our analysis, including the station ID, date, and data about temperatures: <code class="docutils literal notranslate"><span class="pre">'STATION',</span> <span class="pre">'DATE',</span> <span class="pre">'TMAX',</span> <span class="pre">'TMIN'</span></code>. Achieving all these things is pretty straightforward using the <code class="docutils literal notranslate"><span class="pre">.read_csv()</span></code> function, as demonstrated below.</p></li>
</ol>
<!-- #endregion -->
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="c1"># Define relative path to the file</span>
<span class="n">fp</span> <span class="o">=</span> <span class="s2">&quot;data/helsinki-kumpula.txt&quot;</span>

<span class="c1"># Read data using varying amount of spaces as separator,</span>
<span class="c1"># specifying &#39;-9999&#39; characters as NoData values,</span>
<span class="c1"># and selecting only specific columns from the data</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">fp</span><span class="p">,</span>
    <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span>
    <span class="n">skiprows</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-9999&quot;</span><span class="p">],</span>
    <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;TMAX&quot;</span><span class="p">,</span> <span class="s2">&quot;TMIN&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
<!-- #region editable=true slideshow={"slide_type": ""} -->
<p>Let’s now check the data by printing the first five rows with the <code class="docutils literal notranslate"><span class="pre">.head()</span></code> function.</p>
<!-- #endregion -->
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p>Perfect, looks good. We have excluded some unnecessary columns, skipped the row of dashes, and converted the <code class="docutils literal notranslate"><span class="pre">-9999</span></code> values to <code class="docutils literal notranslate"><span class="pre">NaN</span></code> values (we will confirm this later in this section).</p>
</section>
<section id="renaming-columns">
<h2>Renaming columns<a class="headerlink" href="#renaming-columns" title="Link to this heading">#</a></h2>
<p>Let’s take a closer look at the column names of our <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
<p>As we see, some of the column names could be unclear with only their names. Luckily, it is easy to change labels in a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> using the <code class="docutils literal notranslate"><span class="pre">.rename()</span></code> function. In order to change the column names, we need to tell <code class="docutils literal notranslate"><span class="pre">pandas</span></code> how we want to rename the columns using a <em><a class="reference internal" href="../../../back-matter/nb/glossary.html#term-Dictionary"><span class="xref std std-term">dictionary</span></a></em> that converts the old names to new ones. A dictionary is a specific data structure in Python for storing key-value pairs. We can define the new column names using a dictionary where we list <code class="docutils literal notranslate"><span class="pre">key:</span> <span class="pre">value</span></code> pairs in following manner:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">STATION</span></code>: <code class="docutils literal notranslate"><span class="pre">STATION_ID</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TMAX</span></code>: <code class="docutils literal notranslate"><span class="pre">TMAX_F</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TMIN</span></code>: <code class="docutils literal notranslate"><span class="pre">TMIN_F</span></code></p></li>
</ul>
<p>Hence, the original column name (e.g., <code class="docutils literal notranslate"><span class="pre">STATION</span></code>) is the dictionary <code class="docutils literal notranslate"><span class="pre">key</span></code> which will be converted to a new column name <code class="docutils literal notranslate"><span class="pre">STATION_ID</span></code> (which is the <code class="docutils literal notranslate"><span class="pre">value</span></code>). In addition, the temperature values in this data file are represented in degrees Fahrenheit. We will soon convert those temperatures to degrees Celsius. Thus, in order to avoid confusion with the columns, let’s rename the columns <code class="docutils literal notranslate"><span class="pre">TMAX</span></code> to <code class="docutils literal notranslate"><span class="pre">TMAX_F</span></code>, and <code class="docutils literal notranslate"><span class="pre">TMIN</span></code> to <code class="docutils literal notranslate"><span class="pre">TMIN_F</span></code>. Below we can create a dictionary for the new column names.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">new_names</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;STATION&quot;</span><span class="p">:</span> <span class="s2">&quot;STATION_ID&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TMAX&quot;</span><span class="p">:</span> <span class="s2">&quot;TMAX_F&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TMIN&quot;</span><span class="p">:</span> <span class="s2">&quot;TMIN_F&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">new_names</span>
</pre></div>
</div>
<p>Our dictionary format looks correct, so now we can change the column names by passing that dictionary with the parameter <code class="docutils literal notranslate"><span class="pre">columns</span></code> in the <code class="docutils literal notranslate"><span class="pre">.rename()</span></code> function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">new_names</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
<p>Perfect, now our column names are easier to understand and use.</p>
</section>
<section id="using-functions-with-pandas">
<h2>Using functions with pandas<a class="headerlink" href="#using-functions-with-pandas" title="Link to this heading">#</a></h2>
<p>Now it’s time to convert those temperatures from degrees Fahrenheit to degrees Celsius. We have done this many times before, but this time we will learn how to apply our own functions to data in a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>. We will define a function for the temperature conversion and then apply this function for each Fahrenheit value on each row of the <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>. The output Celsius values will be stored in a new column called <code class="docutils literal notranslate"><span class="pre">TMAX_C</span></code>, for example. But first, it is a good idea to check some basic properties of our input data before proceeding with data analysis.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># First rows</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Last rows</span>
<span class="n">data</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Data types</span>
<span class="n">data</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
<p>Nothing suspicious in the first and last rows, but here the <code class="docutils literal notranslate"><span class="pre">.info()</span></code> function indicates that the number of observations per column varies if you compare the <code class="docutils literal notranslate"><span class="pre">Non-Null</span> <span class="pre">Count</span></code> information to the number of entries in the data (n = 6821). Only the station number and date seem to have data for each row. The other columns appear to have a few missing values. This is not necessarily anything dangerous, but good to keep in mind. Let’s now check the descriptive statistics.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Descriptive stats</span>
<span class="n">data</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<p>Looking at the <code class="docutils literal notranslate"><span class="pre">TMAX_F</span></code> values (maximum daily temperatures in Fahrenheit), we can confirm that our measurements seems more or less valid because the value range of the temperatures makes sense (i.e., there are no outliers such as extremely high or low values) and there are not any <code class="docutils literal notranslate"><span class="pre">-9999</span></code> values that were not converted to <code class="docutils literal notranslate"><span class="pre">NaN</span></code>. It is always a good practice to critically inspect your data before doing any analysis, as it is possible that your data may include incorrect values (e.g., due to a sensor malfunction or human error).</p>
<section id="defining-a-function">
<h3>Defining a function<a class="headerlink" href="#defining-a-function" title="Link to this heading">#</a></h3>
<p>Now that we are sure that our data looks correct, and we can start our temperature conversion process by first defining our function to convert from Fahrenheit to Celsius. <code class="docutils literal notranslate"><span class="pre">pandas</span></code> can use regular functions, so you can simply define functions for <code class="docutils literal notranslate"><span class="pre">pandas</span></code> exactly the same way as you would do normally (as we learned in Chapter 2, for instance). Let’s define a function that converts from degrees Fahrenheit to Celsius.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">fahr_to_celsius</span><span class="p">(</span><span class="n">temp_fahrenheit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to convert Fahrenheit temperature into Celsius.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    temp_fahrenheit: int | float</span>
<span class="sd">        Input temperature in Fahrenheit (should be a number)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    Temperature in Celsius (float)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert the Fahrenheit into Celsius</span>
    <span class="n">converted_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_fahrenheit</span> <span class="o">-</span> <span class="mi">32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.8</span>

    <span class="k">return</span> <span class="n">converted_temp</span>
</pre></div>
</div>
<p>Now we have the function defined and stored in memory. At this point it is good to test the function with a known value to make sure it works properly.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fahr_to_celsius</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
<p>32 degrees Fahrenheit is indeed 0 degrees Celsius, so our function seem to be working correctly.</p>
</section>
<section id="using-a-function-by-iterating-over-rows">
<h3>Using a function by iterating over rows<a class="headerlink" href="#using-a-function-by-iterating-over-rows" title="Link to this heading">#</a></h3>
<p>Next we will learn how to use our function with data stored in a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>. We will first apply the function row by row using a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop and then we will learn a more efficient way of applying the function to all rows at once.</p>
<p>Looping over rows in a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> can be done in a few different ways. A common approach is to use the <code class="docutils literal notranslate"><span class="pre">.iterrows()</span></code> method which loops over the rows as index-Series pairs. In other words, we can use the <code class="docutils literal notranslate"><span class="pre">.iterrows()</span></code> method together with a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop to repeat a process for each row in a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>. Please note that iterating over rows this way is a rather inefficient approach, but it is still useful to understand the logic behind how this works. When using the <code class="docutils literal notranslate"><span class="pre">.iterrows()</span></code> method it is important to understand that <code class="docutils literal notranslate"><span class="pre">.iterrows()</span></code> accesses not only the values of one row, but also the <code class="docutils literal notranslate"><span class="pre">index</span></code> of the row. Let’s start with a simple example <code class="docutils literal notranslate"><span class="pre">for</span></code> loop that goes through each row in our <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Iterate over the rows</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="c1"># Print the index value</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index: </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Print the temperature from the row</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TMIN F: </span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;TMIN_F&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">break</span>
</pre></div>
</div>
<p>We can see that the <code class="docutils literal notranslate"><span class="pre">idx</span></code> variable indeed contains the index value <code class="docutils literal notranslate"><span class="pre">0</span></code> (the first row) and the <code class="docutils literal notranslate"><span class="pre">row</span></code> variable contains all the data from that row stored as a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">Series</span></code>. Also, notice that when developing a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop you do not always need to iterate through the entire loop if you just want to test things out. Using the <code class="docutils literal notranslate"><span class="pre">break</span></code> statement in Python terminates a loop wherever it is placed inside the loop. In our case we used it to check out the values on the first row of the <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>. This saves time and allows us to test the code logic without printing thousands of values to the screen!</p>
<p>Next, let’s create an empty column <code class="docutils literal notranslate"><span class="pre">TMIN_C</span></code> for the Celsius temperatures and update the values in that column using the <code class="docutils literal notranslate"><span class="pre">fahr_to_celsius()</span></code> function that we defined earlier. For updating the value in the <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>, we can use the <code class="docutils literal notranslate"><span class="pre">.at[]</span></code> indexer that we used earlier in this chapter. This time, however, we will use the <code class="docutils literal notranslate"><span class="pre">.itertuples()</span></code> method to access the rows in the <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>. The <code class="docutils literal notranslate"><span class="pre">.itertuples()</span></code> method works similarly to <code class="docutils literal notranslate"><span class="pre">.iterrows()</span></code>, except it returns only the row values without the <code class="docutils literal notranslate"><span class="pre">index</span></code>. In addition,  the returned values are not a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">Series</span></code>, but instead <code class="docutils literal notranslate"><span class="pre">.itertuples()</span></code> returns a named tuple data type. As a result, when using <code class="docutils literal notranslate"><span class="pre">.itertuples()</span></code> accessing the row values needs to be done a bit differently. Remember, a <a class="reference internal" href="../../../back-matter/nb/glossary.html#term-Tuple"><span class="xref std std-term">tuple</span></a> is like a list but <a class="reference internal" href="../../../back-matter/nb/glossary.html#term-Immutable"><span class="xref std std-term">immutable</span></a> and a “named tuple” is a special kind of tuple object that adds the ability to access the values by name instead of position index. Thus, we can access the <code class="docutils literal notranslate"><span class="pre">TMIN_F</span></code> value in a given row using <code class="docutils literal notranslate"><span class="pre">row.TMIN_F</span></code> (in contrast to how we accessed the value in the example above). We will not work with named tuples in the rest of the book, but more information can be found in the <a class="reference external" href="https://docs.python.org/3/library/collections.html#collections.namedtuple">Python documentation for named tuples</a> <a class="footnote-reference brackets" href="#namedtuple" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a>.</p>
<p>Let’s see an example of how to use the <code class="docutils literal notranslate"><span class="pre">.itertuples()</span></code> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an empty column for the output values</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;TMIN_C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="c1"># Iterate over the rows</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
    <span class="c1"># Convert the Fahrenheit to Celsius</span>
    <span class="c1"># Notice how we access the row value</span>
    <span class="n">celsius</span> <span class="o">=</span> <span class="n">fahr_to_celsius</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">TMIN_F</span><span class="p">)</span>

    <span class="c1"># Update the value for &#39;Celsius&#39; column with the converted value</span>
    <span class="c1"># Notice how we can access the Index value</span>
    <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span> <span class="s2">&quot;TMIN_C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">celsius</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check the result</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># What does our row look like?</span>
<span class="n">row</span><span class="o">.</span><span class="n">_asdict</span><span class="p">()</span>
</pre></div>
</div>
<p>Okay, now we have iterated over our data, converted the temperatures to degrees Celsius using our <code class="docutils literal notranslate"><span class="pre">fahr_to_celsius()</span></code> function, and stored the results in the <code class="docutils literal notranslate"><span class="pre">TMIN_C</span></code> column. The values look correct as 32 degrees Fahrenheit is 0 degrees Celsius, which can be seen on the first row. We also have the last row of our <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> stored in the variable <code class="docutils literal notranslate"><span class="pre">row</span></code> from the code above, which is a named tuple that has been converted to the dictionary data type using the <code class="docutils literal notranslate"><span class="pre">._asdict()</span></code> method for named tuples.</p>
<p>Before moving to other more efficient ways to use functions with a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>, we should note a few things about the approaches above. We demonstrated use of the <code class="docutils literal notranslate"><span class="pre">.itertuples()</span></code> method for looping over the values because it is significantly faster than <code class="docutils literal notranslate"><span class="pre">.iterrows()</span></code> (can be around 100 times faster). We also used <code class="docutils literal notranslate"><span class="pre">.at[]</span></code> to assign the value in the <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> because it is designed to access single values more efficiently than the <code class="docutils literal notranslate"><span class="pre">.loc[]</span></code> indexer, which can access groups of rows and columns. That said, you could have also simply used <code class="docutils literal notranslate"><span class="pre">data.loc[idx,</span> <span class="pre">new_column]</span> <span class="pre">=</span> <span class="pre">celsius</span></code> to achieve the same result as both examples above. It is simply slower.</p>
</section>
<section id="using-a-function-with-the-apply-method">
<h3>Using a function with the apply method<a class="headerlink" href="#using-a-function-with-the-apply-method" title="Link to this heading">#</a></h3>
<p>Although using a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop with <code class="docutils literal notranslate"><span class="pre">.itertuples()</span></code> can be fairly efficient, the <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> and <code class="docutils literal notranslate"><span class="pre">Series</span></code> data structures have a dedicated method called <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> for applying functions in columns (or rows). <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> is typically faster than <code class="docutils literal notranslate"><span class="pre">.itertuples()</span></code>, especially if you have a large number of rows. When using <code class="docutils literal notranslate"><span class="pre">.apply()</span></code>, we pass the function that we want to use as an argument. Let’s start by applying our <code class="docutils literal notranslate"><span class="pre">fahr_to_celsius()</span></code> function to the <code class="docutils literal notranslate"><span class="pre">TMIN_F</span></code> column with the temperature values in Fahrenheit.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TMIN_F&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fahr_to_celsius</span><span class="p">)</span>
</pre></div>
</div>
<p>The results again look logical. Notice how we passed the <code class="docutils literal notranslate"><span class="pre">fahr_to_celsius()</span></code> function without using the parentheses <code class="docutils literal notranslate"><span class="pre">()</span></code> after the name of the function. When using <code class="docutils literal notranslate"><span class="pre">.apply()</span></code>, you should always leave out the parentheses from the function that you use. In other words, you should use <code class="docutils literal notranslate"><span class="pre">.apply(fahr_to_celsius)</span></code> not <code class="docutils literal notranslate"><span class="pre">.apply(fahr_to_celsius())</span></code>. Why? Because the <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> method will execute and use the function itself in the background when it operates with the data. If we would pass our function including the parentheses, the <code class="docutils literal notranslate"><span class="pre">fahr_to_celsius()</span></code> function would actually be executed once before the loop with <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> starts (thus becoming unusable) and that is not what we want.</p>
<p>Our previous command only returned the <code class="docutils literal notranslate"><span class="pre">Series</span></code> of temperatures to the screen, but naturally we can also store them permanently in a column of our <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> (overwriting the old values).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TMIN_C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TMIN_F&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fahr_to_celsius</span><span class="p">)</span>
</pre></div>
</div>
<p>A nice thing with <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> is that we can also apply the function on several columns at once. Below, we also sort the values in descending order based on values in the <code class="docutils literal notranslate"><span class="pre">TMIN_F</span></code> column to confirm that applying our function really works.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TMAX_F&quot;</span><span class="p">,</span> <span class="s2">&quot;TMIN_F&quot;</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fahr_to_celsius</span><span class="p">)</span>
<span class="n">result</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;TMIN_F&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p>You can also directly store the outputs to the <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> columns <code class="docutils literal notranslate"><span class="pre">TMAX_C</span></code> and <code class="docutils literal notranslate"><span class="pre">TMIN_C</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TMAX_F&quot;</span><span class="p">,</span> <span class="s2">&quot;TMIN_F&quot;</span><span class="p">]</span>
<span class="n">newcols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TMAX_C&quot;</span><span class="p">,</span> <span class="s2">&quot;TMIN_C&quot;</span><span class="p">]</span>
<span class="n">data</span><span class="p">[</span><span class="n">newcols</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fahr_to_celsius</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p>In this section, we showed you a few different ways to iterate over rows in <code class="docutils literal notranslate"><span class="pre">pandas</span></code> and apply functions. The most important thing is that you understand the logic of how loops work and how you can use your own functions to modify the values in a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>. Whenever you need to loop over your data, we recommend using <code class="docutils literal notranslate"><span class="pre">.apply()</span></code> as it is typically the most efficient one in terms of execution time. Remember that in most cases you do not need to use loops. Instead you can do calculations in a “vectorized manner” (which is the fastest way) as we learned previously when doing basic calculations in <code class="docutils literal notranslate"><span class="pre">pandas</span></code>.</p>
</section>
</section>
<section id="string-slicing">
<h2>String slicing<a class="headerlink" href="#string-slicing" title="Link to this heading">#</a></h2>
<p>We will eventually want to group our data based on month in order to see if the temperatures in June of 2021 were higher than on average (which is the goal in our analysis as you might recall). Currently, the date and time information is stored in the column <code class="docutils literal notranslate"><span class="pre">DATE</span></code> that has a structure <code class="docutils literal notranslate"><span class="pre">yyyyMMdd</span></code>. This is a typical timestamp format in which <code class="docutils literal notranslate"><span class="pre">yyyy</span></code> represents the year in a four digit format, <code class="docutils literal notranslate"><span class="pre">MM</span></code> is for the month (two digits), and <code class="docutils literal notranslate"><span class="pre">dd</span></code> is for the day. Let’s have a closer look at the date and time information we have by checking the values in that column and their data type.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">DATE</span></code> column contains dates for the range of observations in our data set. The timestamp for the first observation is <code class="docutils literal notranslate"><span class="pre">20051213</span></code> (December 13th, 2005) and the timestamp for the latest observation is <code class="docutils literal notranslate"><span class="pre">20240831</span></code> (August 31st, 2024). As we can see, the data type (<code class="docutils literal notranslate"><span class="pre">dtype</span></code>) of our column seems to be <code class="docutils literal notranslate"><span class="pre">int64</span></code> (i.e., the information is stored as integer values).</p>
<p>To proceed with our analysis, we want to aggregate this data on a monthly level. In order to do so, we need to “label” each row of data based on the month when the record was observed. Hence, we need to somehow separate information about the year and month for each row. In practice, we can create a new column (or an index) containing information about the month (including the year but excluding days). There are different ways of achieving this, but here we will take advantage of <code class="docutils literal notranslate"><span class="pre">string</span> <span class="pre">slicing</span></code> which means that we convert the date information into character strings and “cut” the needed information from the string objects. The other option would be to convert the timestamp values into something called <code class="docutils literal notranslate"><span class="pre">datetime</span></code> objects, but we will learn about those a bit later. Before further processing, we first want to convert the <code class="docutils literal notranslate"><span class="pre">DATE</span></code> column to character strings for convenience and store those values in a new column called <code class="docutils literal notranslate"><span class="pre">DATE_STR</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DATE_STR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</pre></div>
</div>
<p>If we look at the latest time stamp in the data (<code class="docutils literal notranslate"><span class="pre">20240831</span></code>), you can see that there is a systematic pattern: <code class="docutils literal notranslate"><span class="pre">YEAR-MONTH-DAY</span></code>. The first four characters always represent the year and the following two characters represent the month. Because we are interested in understanding monthly averages for different years, we want to slice the year and month values from the timestamp (the first 6 characters) like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">date</span> <span class="o">=</span> <span class="s2">&quot;20240831&quot;</span>
<span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
</pre></div>
</div>
<p>Using this approach, we can slice the correct range of characters from the <code class="docutils literal notranslate"><span class="pre">DATE_STR</span></code> column using a specific <code class="docutils literal notranslate"><span class="pre">pandas</span></code> function designed for a <code class="docutils literal notranslate"><span class="pre">Series</span></code> called <code class="docutils literal notranslate"><span class="pre">.str.slice()</span></code>. The function has the parameters <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">stop</span></code>, which you can use to specify the positions where the slicing should start and end.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;YEAR_MONTH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;DATE_STR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p>Nice! Now we have “labeled” the rows based on information about the year and month.</p>
<!-- #region editable=true slideshow={"slide_type": ""} tags=["question"] -->
<section id="question-3-7">
<h3>Question 3.7<a class="headerlink" href="#question-3-7" title="Link to this heading">#</a></h3>
<p>Create a new column <code class="docutils literal notranslate"><span class="pre">MONTH</span></code> with information about the month without the year.</p>
<!-- #endregion -->
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use this cell to enter your solution.</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">data</span><span class="p">[</span><span class="s2">&quot;MONTH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;DATE_STR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="grouping-and-aggregating-data">
<h2>Grouping and aggregating data<a class="headerlink" href="#grouping-and-aggregating-data" title="Link to this heading">#</a></h2>
<section id="basic-logic-of-grouping-a-dataframe-using-groupby">
<h3>Basic logic of grouping a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> using <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code><a class="headerlink" href="#basic-logic-of-grouping-a-dataframe-using-groupby" title="Link to this heading">#</a></h3>
<p>In the following sections, we want to calculate the average temperature for each month in our data set. Here, we will learn how to use the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> method, which is a handy tool for combining large amounts of data and computing statistics for subgroups. We will use the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> method to calculate the average temperatures for each month in three main steps:</p>
<ol class="arabic simple">
<li><p>Group the data based on year and month using <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code></p></li>
<li><p>Calculate the average temperature for each month (i.e., each group)</p></li>
<li><p>Store the resulting row into a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> called <code class="docutils literal notranslate"><span class="pre">monthly_data</span></code></p></li>
</ol>
<p>We have many rows of weather data (n = 6821) to process and our goal is to create an aggregated <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> that has only one row per month. We can group the data by month using the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> function by providing the name of the column (or a list of columns) that we want to use as basis for doing the grouping. Let’s group our data based on the unique year and month combinations.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">grouped</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;YEAR_MONTH&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice, that it would also be possible to create combinations of years and months “on the fly” if you have them in separate columns. In such case, grouping the data could be done as <code class="docutils literal notranslate"><span class="pre">grouped</span> <span class="pre">=</span> <span class="pre">data.groupby(['YEAR',</span> <span class="pre">'MONTH'])</span></code>. Let’s explore the new variable <code class="docutils literal notranslate"><span class="pre">grouped</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">grouped</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grouped</span><span class="p">))</span>
</pre></div>
</div>
<p>We have a new object with type <code class="docutils literal notranslate"><span class="pre">DataFrameGroupBy</span></code> with 225 groups. In order to understand what just happened, let’s also check the number of unique year and month combinations in our data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;YEAR_MONTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
</pre></div>
</div>
<p>Length of the grouped object should be the same as the number of unique values in the column we used for grouping (<code class="docutils literal notranslate"><span class="pre">YEAR_MONTH</span></code>). For each unique <code class="docutils literal notranslate"><span class="pre">YEAR_MONTH</span></code> value, there is a group of data. Let’s explore our grouped data further by checking the “names” of the first five groups. Here, we access the <code class="docutils literal notranslate"><span class="pre">keys</span></code> of the groups and convert them to a <code class="docutils literal notranslate"><span class="pre">list</span></code> so that we can slice and print only a few of those to the screen.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">grouped</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<p>Let’s check the contents for a group representing December 2005. We can get the values for that month from the grouped object using the <code class="docutils literal notranslate"><span class="pre">.get_group()</span></code> method.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specify a month (as character string)</span>
<span class="n">month</span> <span class="o">=</span> <span class="s2">&quot;200512&quot;</span>

<span class="c1"># Select the group</span>
<span class="n">group1</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">month</span><span class="p">)</span>
<span class="n">group1</span>
</pre></div>
</div>
<p>As we can see, a single group contains a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> with values only for that specific month. Let’s check the data type of this group.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">group1</span><span class="p">)</span>
</pre></div>
</div>
<p>So, one group is a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>, which is really useful because it allows us to use all the familiar <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> methods for calculating statistics, etc. for this specific group. It is also possible to iterate over the groups in our <code class="docutils literal notranslate"><span class="pre">DataFrameGroupBy</span></code> object which can be useful if you need to conduct and apply some more complicated sub-tasks for each group. When doing so, it is important to understand that a single group in our <code class="docutils literal notranslate"><span class="pre">DataFrameGroupBy</span></code> object actually contains not only the actual values but also information about the <code class="docutils literal notranslate"><span class="pre">key</span></code> that was used to do the grouping. Hence, when iterating we need to assign the <code class="docutils literal notranslate"><span class="pre">key</span></code> and the values (i.e., the group) to separate variables. Let’s see how we can iterate over the groups and print the key and the data from a single group (again using <code class="docutils literal notranslate"><span class="pre">break</span></code> to only see the first group).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Iterate over groups</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
    <span class="c1"># Print key and group</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key:</span><span class="se">\n</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First rows of data in this group:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">group</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Stop iteration with break command</span>
    <span class="k">break</span>
</pre></div>
</div>
<p>Here, we can see that the <code class="docutils literal notranslate"><span class="pre">key</span></code> contains the name of the group (i.e., the unique value from <code class="docutils literal notranslate"><span class="pre">YEAR_MONTH</span></code>).</p>
</section>
<section id="aggregating-data-with-groupby">
<h3>Aggregating data with <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code><a class="headerlink" href="#aggregating-data-with-groupby" title="Link to this heading">#</a></h3>
<p>We can, for example, calculate the average values for all variables using the statistical functions that we have seen already (e.g., <code class="docutils literal notranslate"><span class="pre">.mean()</span></code>, <code class="docutils literal notranslate"><span class="pre">.std()</span></code>, <code class="docutils literal notranslate"><span class="pre">.min()</span></code>, etc.). To calculate the average temperature for each month, we can use the <code class="docutils literal notranslate"><span class="pre">.mean()</span></code> function. Let’s calculate the mean for all the weather related data attributes in our group at once.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specify the columns that will be part of the calculation</span>
<span class="n">mean_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TMAX_F&quot;</span><span class="p">,</span> <span class="s2">&quot;TMIN_F&quot;</span><span class="p">,</span> <span class="s2">&quot;TMAX_C&quot;</span><span class="p">,</span> <span class="s2">&quot;TMIN_C&quot;</span><span class="p">]</span>

<span class="c1"># Calculate the mean values all at one go</span>
<span class="n">mean_values</span> <span class="o">=</span> <span class="n">group1</span><span class="p">[</span><span class="n">mean_cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">mean_values</span>
</pre></div>
</div>
<p>As a result, we get a <code class="docutils literal notranslate"><span class="pre">pandas</span></code> <code class="docutils literal notranslate"><span class="pre">Series</span></code> with mean values calculated for all columns in the group. Notice that if you want to convert this <code class="docutils literal notranslate"><span class="pre">Series</span></code> back into a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> (which can be useful if you want to merge multiple groups, for example), you can use the command <code class="docutils literal notranslate"><span class="pre">.to_frame().T</span></code>, which first converts the Series into a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> and then transposes the order of the axes (the label names become the column names).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert to DataFrame</span>
<span class="n">mean_values</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
<p>To do a similar aggregation with all the groups in our data set, we can combine the <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code> function with the aggregation step (such as taking the mean of the given columns), and finally restructure the resulting <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> a bit. This might be a bit harder to understand at first, but this is how you would group and aggregate the values.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># The columns that we want to aggregate</span>
<span class="n">mean_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TMAX_F&quot;</span><span class="p">,</span> <span class="s2">&quot;TMIN_F&quot;</span><span class="p">,</span> <span class="s2">&quot;TMAX_C&quot;</span><span class="p">,</span> <span class="s2">&quot;TMIN_C&quot;</span><span class="p">]</span>

<span class="c1"># Group and aggregate the data with one line</span>
<span class="n">monthly_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;YEAR_MONTH&quot;</span><span class="p">)[</span><span class="n">mean_cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">monthly_data</span>
</pre></div>
</div>
<p>As we can see, aggregating the data in this way is a fairly straightforward and fast process requiring merely a single command. So what did we actually do here? We (1) grouped the data, (2) selected specific columns from the result (<code class="docutils literal notranslate"><span class="pre">mean_cols</span></code>), (3) calculated the mean for all of the selected columns of the groups, and finally (4) reset the index. Resetting the index at the end is not necessary, but by doing it we turn the <code class="docutils literal notranslate"><span class="pre">YEAR_MONTH</span></code> values into a dedicated column in our data (which would be otherwise be stored as <code class="docutils literal notranslate"><span class="pre">index</span></code>).</p>
<p>What might not be obvious from this example is the fact that each group is actually iterated over and the aggregation step is repeated for each group. For you to better understand what happens, we will next repeat the same process by iterating over the groups and eventually creating a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> that contains the mean values for all of the weather attributes that we are interested in. In this approach, we will iterate over the groups, calculate the mean values, store the result in a list, and finally merge the aggregated data into a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> called <code class="docutils literal notranslate"><span class="pre">monthly_data</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an empty list for storing the aggregated rows/DataFrames</span>
<span class="n">data_container</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># The columns that we want to aggregate</span>
<span class="n">mean_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TMAX_F&quot;</span><span class="p">,</span> <span class="s2">&quot;TMIN_F&quot;</span><span class="p">,</span> <span class="s2">&quot;TMAX_C&quot;</span><span class="p">,</span> <span class="s2">&quot;TMIN_C&quot;</span><span class="p">]</span>

<span class="c1"># Iterate over the groups</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
    <span class="c1"># Calculate mean</span>
    <span class="n">mean_values</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">mean_cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="c1"># Add the &quot;key&quot; (i.e., the date+time information) into the Series</span>
    <span class="n">mean_values</span><span class="p">[</span><span class="s2">&quot;YEAR_MONTH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>

    <span class="c1"># Convert the Series into a DataFrame and</span>
    <span class="c1"># append the aggregated values into a list as a DataFrame</span>
    <span class="n">data_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_values</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="c1"># After iterating over all groups, merge the list of DataFrames</span>
<span class="n">monthly_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data_container</span><span class="p">)</span>
<span class="n">monthly_data</span>
</pre></div>
</div>
<p>As a result, we get identical results to those produced by the approach that was done earlier with a single line of code (except for the position of the <code class="docutils literal notranslate"><span class="pre">YEAR_MONTH</span></code> column).</p>
<p>So which approach should you use? From the performance point of view, we recommend using the first approach (i.e., chaining), which does not require you to use a separate <code class="docutils literal notranslate"><span class="pre">for</span></code> loop, and is highly efficient. However, this approach might be a bit more difficult to read and comprehend (the loop might be easier). Also, sometimes you want to include additional processing steps within the loop that can be hard accomplish by chaining everything into a single command. Hence, it is useful to know both of these approaches for doing aggregations of the data.</p>
</section>
</section>
<section id="case-study-detecting-warm-months">
<h2>Case study: Detecting warm months<a class="headerlink" href="#case-study-detecting-warm-months" title="Link to this heading">#</a></h2>
<p>Now that we have aggregated our data on monthly level, all we need to do is to check which years had the warmest June temperatures. A simple approach is to select all June values from the data and check which group(s) have the highest mean value. Before doing this, let’s separate the month information from our timestamp following the same approach as previously we did when slicing the year-month combination.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">monthly_data</span><span class="p">[</span><span class="s2">&quot;MONTH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">monthly_data</span><span class="p">[</span><span class="s2">&quot;YEAR_MONTH&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">monthly_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p>Let’s also make an estimate of the mean monthly temperature <code class="docutils literal notranslate"><span class="pre">TAVG_C</span></code> as the average of <code class="docutils literal notranslate"><span class="pre">TMIN_C</span></code> and <code class="docutils literal notranslate"><span class="pre">TMAX_C</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">monthly_data</span><span class="p">[</span><span class="s2">&quot;TAVG_C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">monthly_data</span><span class="p">[</span><span class="s2">&quot;TMAX_C&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">monthly_data</span><span class="p">[</span><span class="s2">&quot;TMIN_C&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
</pre></div>
</div>
<p>Now we can select the values for June from our data and store it into a new variable <code class="docutils literal notranslate"><span class="pre">june_data</span></code>. Then we can check the highest temperature values by sorting the <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> by the <code class="docutils literal notranslate"><span class="pre">TAVG_C</span></code> column in descending order.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">june_data</span> <span class="o">=</span> <span class="n">monthly_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">monthly_data</span><span class="p">[</span><span class="s2">&quot;MONTH&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;06&quot;</span><span class="p">]</span>
<span class="n">june_data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;TAVG_C&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p>By looking at the order of <code class="docutils literal notranslate"><span class="pre">YEAR_MONTH</span></code> column, we can see that June 2021 is indeed the warmest June on record for the Helsinki Kumpula weather station (as of 2024) based on the estimated average monthly temperatures. Let’s now explore similar temperature data from other weather stations in Finland and see whether June of 2021 has been exceptionally warm in other locations.</p>
</section>
<section id="automating-the-analysis">
<h2>Automating the analysis<a class="headerlink" href="#automating-the-analysis" title="Link to this heading">#</a></h2>
<p>Above, we learned how to aggregate data using <code class="docutils literal notranslate"><span class="pre">pandas</span></code> to calculate average monthly temperatures based on daily weather observations. With these skills, we can now take advantage of one of the most useful aspects of programming: automating processes and repeating analyses for any number of similar data files (assuming the data structure is the same).</p>
<p>Let’s now see how we can repeat the previous data analysis steps for 15 weather stations located in different parts of Finland containing data for up to 116 years (1908-2024). The idea is that we will repeat the process for each input file using a (rather long) <code class="docutils literal notranslate"><span class="pre">for</span></code> loop. We will use the most efficient alternatives of the previously represented approaches, and finally will store the results in a single <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> for all stations. We will learn how to manipulate file paths in Python using the <code class="docutils literal notranslate"><span class="pre">pathlib</span></code> module and see how we can list our input files in the data directory <code class="docutils literal notranslate"><span class="pre">data/finnish-stations</span></code>. We will store those paths in the variable <code class="docutils literal notranslate"><span class="pre">file_list</span></code> so that we can use the file paths easily in the later steps.</p>
<section id="managing-and-listing-filesystem-paths">
<h3>Managing and listing filesystem paths<a class="headerlink" href="#managing-and-listing-filesystem-paths" title="Link to this heading">#</a></h3>
<p>In Python there are two commonly used approaches to manage and manipulate file paths, namely the <code class="docutils literal notranslate"><span class="pre">os.path</span></code> sub-module and the newer <code class="docutils literal notranslate"><span class="pre">pathlib</span></code> module (available since Python 3.4), which we will demonstrate here. The built-in module <code class="docutils literal notranslate"><span class="pre">pathlib</span></code> provides many useful functions for interacting and manipulating file paths in your operating system. In the following example, we have data in different files in a sub-folder and will learn how to use the <code class="docutils literal notranslate"><span class="pre">Path</span></code> class from the <code class="docutils literal notranslate"><span class="pre">pathlib</span></code> library to construct file paths. To start, we will import and use the <code class="docutils literal notranslate"><span class="pre">Path</span></code> class and see how we can construct a file path by joining a folder path and a file name.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Initialize the Path</span>
<span class="n">input_folder</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;data/finnish-stations&quot;</span><span class="p">)</span>

<span class="c1"># Join folder path and filename</span>
<span class="n">fp</span> <span class="o">=</span> <span class="n">input_folder</span> <span class="o">/</span> <span class="s2">&quot;enontekio-kilpisjarvi.txt&quot;</span>
<span class="n">fp</span>
</pre></div>
</div>
<p>Above, we first initialized the <code class="docutils literal notranslate"><span class="pre">Path</span></code> object and stored it in the variable <code class="docutils literal notranslate"><span class="pre">input_folder</span></code> by passing a relative path as a string indicating the directory where all our files are located. Then we created a complete file path to the file <code class="docutils literal notranslate"><span class="pre">enontekio-kilpisjarvi.txt</span></code> by adding a forward slash (<code class="docutils literal notranslate"><span class="pre">/</span></code>) character between the folder and the filename which joins them together (easy!). In this case, our end result is something called a <code class="docutils literal notranslate"><span class="pre">PosixPath</span></code>, which is a file system path to a given file in the Linux or macOS operating systems. If you would run the same commands on a computer using the Windows operating system, the end result would be a <code class="docutils literal notranslate"><span class="pre">WindowsPath</span></code> object. Thus, the output depends on which operating system you are using. However, you do not need to worry about this because both types of Paths work exactly the same no matter which operating system you use.</p>
<p>Both the <code class="docutils literal notranslate"><span class="pre">Path</span></code> object that we stored in the <code class="docutils literal notranslate"><span class="pre">input_folder</span></code> variable and the <code class="docutils literal notranslate"><span class="pre">PosixPath</span></code> object that we stored in variable <code class="docutils literal notranslate"><span class="pre">fp</span></code> are actually quite versatile creatures, and we can do many useful things with them. For instance, we can find the parent folder where the file is located, extract the filename from the full path, test whether the file or directory actually exists, find various properties of the file (such as size of the file or creation time), and so on. Let’s see a few examples below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fp</span><span class="o">.</span><span class="n">parent</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fp</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fp</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File properties</span>
<span class="n">size_in_bytes</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span>
<span class="n">creation_time</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_ctime</span>
<span class="n">modified_time</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;Size (bytes): </span><span class="si">{</span><span class="n">size_in_bytes</span><span class="si">}</span><span class="se">\n</span><span class="s2">Created (seconds since Epoch): </span><span class="si">{</span><span class="n">creation_time</span><span class="si">}</span><span class="se">\n</span><span class="s2">Modified (seconds since Epoch): </span><span class="si">{</span><span class="n">modified_time</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>There are also various other methods that you can use from the <code class="docutils literal notranslate"><span class="pre">pathlib</span></code> module, such as for renaming files (<code class="docutils literal notranslate"><span class="pre">.rename()</span></code>) or creating directories (<code class="docutils literal notranslate"><span class="pre">.mkdir()</span></code>). You can see all available methods from the <a class="reference external" href="https://docs.python.org/3/library/pathlib.html"><code class="docutils literal notranslate"><span class="pre">pathlib</span></code> documentation</a> <a class="footnote-reference brackets" href="#pathlib" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>. One of the most useful tools in <code class="docutils literal notranslate"><span class="pre">pathlib</span></code> is the ability to list all of the files within a given directory using the <code class="docutils literal notranslate"><span class="pre">.glob()</span></code> method, which also allows you to add specific search criteria for listing only specific files from a directory.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">file_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_folder</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*txt&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>Here, the result is stored in the variable <code class="docutils literal notranslate"><span class="pre">file_list</span></code> as a list. By default, the <code class="docutils literal notranslate"><span class="pre">.glob()</span></code> function produces something called a <code class="docutils literal notranslate"><span class="pre">generator</span></code> which is a “lazy iterator” (a special kind of function that allows you to iterate over items like a list, but without actually storing the data in memory). By enclosing the <code class="docutils literal notranslate"><span class="pre">.glob()</span></code> search functionality in the <code class="docutils literal notranslate"><span class="pre">list()</span></code> function, we convert this generator into a normal Python list. Note that we’re using the * character as a wildcard, so any filename that ends with <code class="docutils literal notranslate"><span class="pre">txt</span></code> will be added to the list of files. Let’s take a look what we produced as a result.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of files in the list: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">file_list</span>
</pre></div>
</div>
</section>
<section id="iterate-over-input-files-and-repeat-the-analysis">
<h3>Iterate over input files and repeat the analysis<a class="headerlink" href="#iterate-over-input-files-and-repeat-the-analysis" title="Link to this heading">#</a></h3>
<p>At this point we should have all the relevant file paths in the <code class="docutils literal notranslate"><span class="pre">file_list</span></code> variable, and we can loop over the list using a <code class="docutils literal notranslate"><span class="pre">for</span></code> loop (again we will break the loop after the first iteration).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
    <span class="k">break</span>
</pre></div>
</div>
<p>The data we have in the data files are formatted just like the example file we have used in this section (in fact, it is one of the files in our data directory). Thus, we can easily the file data using the <code class="docutils literal notranslate"><span class="pre">pd.read_csv()</span></code> function with the same parameter values specified earlier.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">fp</span><span class="p">,</span>
    <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span>
    <span class="n">skiprows</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-9999&quot;</span><span class="p">],</span>
    <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;TMAX&quot;</span><span class="p">,</span> <span class="s2">&quot;TMIN&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<p>Now that we have all the file paths for our weather observation data sets in a list, we can start iterating over them and repeat the analysis steps for each file separately. We will keep all the analytical steps inside a loop so that all of them are repeated for the different stations. Finally, we will store the warmest June for each station in a list called <code class="docutils literal notranslate"><span class="pre">results</span></code> using a regular Python list’s <code class="docutils literal notranslate"><span class="pre">.append()</span></code> method and merge the list of <code class="docutils literal notranslate"><span class="pre">DataFrames</span></code> into one using the <code class="docutils literal notranslate"><span class="pre">pd.concat()</span></code> function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># A list for storing the result</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Repeat the analysis steps for each input file:</span>
<span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
    <span class="c1"># Read the data from text file</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">fp</span><span class="p">,</span>
        <span class="n">sep</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;\s+&quot;</span><span class="p">,</span>
        <span class="n">skiprows</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-9999&quot;</span><span class="p">],</span>
        <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;STATION&quot;</span><span class="p">,</span> <span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;TMAX&quot;</span><span class="p">,</span> <span class="s2">&quot;TMIN&quot;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Rename the columns</span>
    <span class="n">new_names</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;STATION&quot;</span><span class="p">:</span> <span class="s2">&quot;STATION_ID&quot;</span><span class="p">,</span>
        <span class="s2">&quot;TMAX&quot;</span><span class="p">:</span> <span class="s2">&quot;TMAX_F&quot;</span><span class="p">,</span>
        <span class="s2">&quot;TMIN&quot;</span><span class="p">:</span> <span class="s2">&quot;TMIN_F&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">new_names</span><span class="p">)</span>

    <span class="c1"># Print info about the current input file</span>
    <span class="c1"># This is useful to understand how the process proceeds</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;STATION NUMBER: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;STATION_ID&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="s2">NUMBER OF OBSERVATIONS: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Estimate daily average temperature as average of TMAX and TMIN</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TAVG_F&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TMAX_F&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TMIN_F&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="c1"># Create column</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TAVG_C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Convert temperatures from Fahrenheit to Celsius</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TAVG_C&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TAVG_F&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fahr_to_celsius</span><span class="p">)</span>

    <span class="c1"># Convert DATE to string</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;DATE_STR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="c1"># Parse year and month and convert them to numbers</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;MONTH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;DATE_STR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;YEAR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;DATE_STR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Extract observations for the months of June</span>
    <span class="n">june</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;MONTH&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">]</span>

    <span class="c1"># Aggregate the data and get mean values</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TAVG_F&quot;</span><span class="p">,</span> <span class="s2">&quot;TAVG_C&quot;</span><span class="p">]</span>
    <span class="n">monthly_mean</span> <span class="o">=</span> <span class="n">june</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;YEAR&quot;</span><span class="p">,</span> <span class="s2">&quot;MONTH&quot;</span><span class="p">])[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># Sort the values and take the warmest June</span>
    <span class="n">warmest</span> <span class="o">=</span> <span class="n">monthly_mean</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;TAVG_C&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Save data file name in DataFrame</span>
    <span class="n">warmest</span><span class="p">[</span><span class="s2">&quot;FILE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">name</span>

    <span class="c1"># Add to results</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">warmest</span><span class="p">)</span>

<span class="c1"># Merge all the results into a single DataFrame</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
<p>Awesome! Now we have conducted the same analysis for 15 weather stations in Finland and it did not take many lines of code! We were able to follow how the process in real time via the information printed as the data were analyzed (i.e., we did some simple “logging” of the operations). Let’s finally investigate our results.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">results</span>
</pre></div>
</div>
<p>Each row in the results represents the warmest June at given station starting between 1908-2005 and ending in 2024. Based on the <code class="docutils literal notranslate"><span class="pre">YEAR</span></code> column, the warmest June in the majority of weather stations we have used was indeed in 2021. We can confirm this by checking the value counts for the <code class="docutils literal notranslate"><span class="pre">YEAR</span></code> column.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;YEAR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
<p>It seems at least the start of summer in 2021 was abnormally warm in Finland!</p>
</section>
</section>
<section id="footnotes">
<h2>Footnotes<a class="headerlink" href="#footnotes" title="Link to this heading">#</a></h2>
<hr class="footnotes docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="ylenews" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://yle.fi/a/3-12082062">https://yle.fi/a/3-12082062</a></p>
</aside>
<aside class="footnote brackets" id="namedtuple" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://docs.python.org/3/library/collections.html#collections.namedtuple">https://docs.python.org/3/library/collections.html#collections.namedtuple</a></p>
</aside>
<aside class="footnote brackets" id="pathlib" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">3</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://docs.python.org/3/library/pathlib.html">https://docs.python.org/3/library/pathlib.html</a></p>
</aside>
</aside>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "Python-GIS-book/site",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./part1/chapter-03/md"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cleaning-data-while-reading">Cleaning data while reading</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#renaming-columns">Renaming columns</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-functions-with-pandas">Using functions with pandas</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#defining-a-function">Defining a function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-a-function-by-iterating-over-rows">Using a function by iterating over rows</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-a-function-with-the-apply-method">Using a function with the apply method</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#string-slicing">String slicing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#question-3-7">Question 3.7</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#grouping-and-aggregating-data">Grouping and aggregating data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#basic-logic-of-grouping-a-dataframe-using-groupby">Basic logic of grouping a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> using <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-data-with-groupby">Aggregating data with <code class="docutils literal notranslate"><span class="pre">.groupby()</span></code></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#case-study-detecting-warm-months">Case study: Detecting warm months</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#automating-the-analysis">Automating the analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#managing-and-listing-filesystem-paths">Managing and listing filesystem paths</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iterate-over-input-files-and-repeat-the-analysis">Iterate over input files and repeat the analysis</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#footnotes">Footnotes</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Henrikki Tenkanen, Vuokko Heikinheimo, David Whipp
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2020-2025, Henrikki Tenkanen, Vuokko Heikinheimo, David Whipp.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>